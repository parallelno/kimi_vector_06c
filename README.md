# kimi_vector_06c
This is the Vector 06C emulator generated by the kimi.com LLM.
Although it's very limited and incomplete, the quality achieved within several prompts is still impressive!

/*************  ✨ Windsurf Command ⭐  *************/
![kimi_vector_06c](imgs/Screenshot2025-11-07_232039.png)
/*******  58a67227-8816-4cc9-8a23-02f09aa8a391  *******/

https://parallelno.github.io/kimi_vector_06c/

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vector06C Emulator (Debug Edition)</title>
<style>
    body {
        margin: 0;
        padding: 0;
        background: #1a1a1a;
        color: #eee;
        font-family: 'Courier New', monospace;
        overflow: hidden;
    }

    .main-container {
        display: flex;
        height: 100vh;
    }

    .left-panel {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        min-width: 520px;
        background: #1a1a1a;
    }

    .right-panel {
        flex: 0 0 auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #1a1a1a;
    }

    #screen {
        border: 3px solid #444;
        background: #000;
        image-rendering: pixelated;
        width: 512px;
        height: 512px;
    }

    #controls {
        margin-top: 15px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 512px;
    }

    button {
        padding: 8px 12px;
        background: #333;
        color: #eee;
        border: 1px solid #555;
        cursor: pointer;
        font-family: inherit;
        font-size: 11px;
    }

    button:hover {
        background: #444;
    }

    button:active {
        background: #555;
    }

    button.danger {
        background: #622;
    }

    button.danger:hover {
        background: #733;
    }

    #status {
        margin-top: 10px;
        font-size: 12px;
        text-align: center;
        max-width: 512px;
    }

    #info {
        margin-top: 15px;
        font-size: 11px;
        line-height: 1.4;
        color: #ccc;
        max-width: 512px;
    }

    kbd {
        background: #333;
        padding: 2px 4px;
        border: 1px solid #555;
    }

    #debugToggle {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }

    #debugPanel {
        margin-top: 10px;
        background: #222;
        border: 2px solid #444;
        padding: 10px;
    }

    .debug-table {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        font-size: 10px;
    }

    .debug-section {
        background: #1a1a1a;
        border: 1px solid #333;
        padding: 8px;
        line-height: 1.3;
        overflow: hidden;
    }

    .debug-section h4 {
        margin: 0 0 5px 0;
        color: #888;
        font-size: 11px;
        border-bottom: 1px solid #333;
        padding-bottom: 3px;
    }

    pre {
        margin: 0;
        font-family: 'Courier New', monospace;
    }

    input[type="text"] {
        background: #333;
        color: #eee;
        border: 1px solid #555;
        padding: 3px;
        font-family: inherit;
        font-size: 10px;
        width: 60px;
    }

    .flag-set {
        color: #0F0;
    }

    .flag-clear {
        color: #444;
    }

    #planeView {
        border: 1px solid #555;
        margin-top: 5px;
    }

    .disasm-line {
        line-height: 1.3;
    }

    .disasm-pc {
        background: #333;
        color: #0FF;
    }

    .disasm-breakpoint {
        background: #622;
        color: #FFF;
    }

    h1 {
        margin: 0 0 10px 0;
        font-size: 18px;
        text-align: center;
        color: #eee;
    }

    /* NEW: Hide file input */
    #romFile {
        display: none;
    }

    @media (max-width: 1200px) {
        .main-container {
            flex-direction: column;
        }
        .left-panel {
            min-width: auto;
            order: 2;
        }
        .right-panel {
            order: 1;
        }
        #screen {
            width: 384px;
            height: 384px;
        }
    }
</style>
</head>
<body>
<button id="debugToggle" onclick="toggleDebug()">Debug Panel</button>

<div class="main-container">
    <div class="left-panel">
        <h1>Vector06C Emulator (Debug Edition)</h1>
        <div id="debugPanel">
            <h3>Hardware Debug State</h3>
            <div class="debug-table">
                <div class="debug-section">
                    <h4>CPU State</h4>
                    <pre id="cpuState">PC: 0000 | SP: F000
A: 00 | B: 00 | C: 00
D: 00 | E: 00
H: 00 | L: 00
Flags: S=0 Z=0 AC=0 P=0 C=0
Opcode: 00
HLT: 0</pre>
                </div>

                <div class="debug-section">
                    <h4>Memory Dump</h4>
                    Addr: <input type="text" id="memAddr" value="0100" size="4">
                    <button onclick="updateMemoryDump()" style="padding: 2px 6px; font-size: 10px;">View</button>
                    <pre id="memoryDump">0000: 00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00</pre>
                </div>

                <div class="debug-section">
                    <h4>Video State</h4>
                    <pre id="videoState">Border: 0 (Black)
Plane 0: 8000-9FFF
Plane 1: A000-BFFF
Plane 2: C000-DFFF
Plane 3: E000-FFFF
VRAM: 00 00 00 00 ...</pre>
                    <canvas id="planeView" width="256" height="64"></canvas>
                </div>

                <div class="debug-section">
                    <h4>Sound State</h4>
                    <pre id="soundState">CH: 0:OFF 1:OFF 2:OFF N:OFF
Freq: 0 0 0
Type: TONE TONE TONE NOISE</pre>
                </div>

                <div class="debug-section">
                    <h4>Keyboard Matrix</h4>
                    <pre id="kbdState">Row: 0
0:11111111 1:11111111
2:11111111 3:11111111
4:11111111 5:11111111
6:11111111 7:11111111
Read: FF</pre>
                </div>

                <div class="debug-section">
                    <h4>I/O Ports</h4>
                    <pre id="ioState">P00: 00 (Row)
P01: FF (Kbd)
P02: 0F (Border)
P03: 00 (Sound)</pre>
                </div>

                <div class="debug-section">
                    <h4>Hardware Stats</h4>
                    <pre id="hardwareStats">CPU: -- KHz
RAM: --% VRAM: --%
Uptime: --s
Frames: --
Status: Stopped</pre>
                </div>

                <div class="debug-section">
                    <h4>Disassembly</h4>
                    <input type="text" id="disasmAddr" value="" size="4" placeholder="Addr">
                    <button onclick="updateDisassembly()" style="padding: 2px 6px; font-size: 10px;">Go</button>
                    <button onclick="emulator.updateDisassembly()" style="padding: 2px 6px; font-size: 10px;">Follow PC</button>
                    <pre id="disassembly">; Load program
; and click Follow PC</pre>
                </div>
            </div>
            <div style="margin-top: 8px;">
                <strong>Breakpoints:</strong>
                <input type="text" id="breakpoint" placeholder="BP addr (hex)" size="8">
                <button onclick="emulator.setBreakpoint()" style="padding: 2px 6px; font-size: 10px;">Set</button>
                <button class="danger" onclick="emulator.clearBreakpoints()" style="padding: 2px 6px; font-size: 10px;">Clear</button>
                <span id="bpList" style="margin-left: 8px;">None</span>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <canvas id="screen" width="256" height="256"></canvas>
        <div id="controls">
            <button onclick="emulator.reset()">Reset</button>
            <button onclick="emulator.run()">Run</button>
            <button onclick="emulator.stop()">Stop</button>
            <button onclick="emulator.step()">Step</button>
            <button onclick="emulator.stepOver0x100()">Step 0x100</button>
            <button onclick="loadGraphicsDemo()">GFX Demo</button>
            <button onclick="loadSoundDemo()">SND Demo</button>
            <!-- NEW: ROM Upload Button -->
            <button onclick="document.getElementById('romFile').click()">Load ROM</button>
            <input type="file" id="romFile" accept=".rom,.bin,.hex" onchange="handleROMFile(event)">
        </div>
        <div id="status">Status: Ready | PC: 0000 | Cycles: 0</div>
        <div id="info">
            <strong>Operation:</strong> Programs load at <code>0x0100</code>, execution starts at <code>0x0000</code> (JMP 0x0100)<br>
            <strong>Video:</strong> 256×256, 16 colors, 4 bitplanes, bottom-left origin<br>
            <strong>Keys:</strong> Arrow keys, Space, F1-F5, alphanumeric keys active
        </div>
    </div>
</div>

<script>
// ============================================================================
// Intel 8080 CPU Emulator
// ============================================================================
function CPU8080() {
    this.a = 0; this.b = 0; this.c = 0; this.d = 0;
    this.e = 0; this.h = 0; this.l = 0;
    this.pc = 0; this.sp = 0xF000;
    this.flags = { S:0, Z:0, AC:0, P:0, C:0 };
    this.halted = false;
    this.interrupts = true;
    this.memory = null;
    this.ports = null;
    this.cycles = 0;
    this.lastOpcode = 0;
}

CPU8080.prototype = {
    init: function(memory, ports) {
        this.memory = memory;
        this.ports = ports;
    },

    reset: function() {
        this.pc = 0x0000;
        this.sp = 0xF000;
        this.halted = false;
        this.a = this.b = this.c = this.d = this.e = this.h = this.l = 0;
        this.flags = { S:0, Z:0, AC:0, P:0, C:0 };
        this.cycles = 0;
    },

    setFlags: function(val, cy=false, ac=false) {
        val &= 0xFF;
        this.flags.S = (val & 0x80) ? 1 : 0;
        this.flags.Z = (val === 0) ? 1 : 0;
        this.flags.P = (this.parityTable[val]) ? 1 : 0;
        this.flags.AC = ac ? 1 : 0;
        this.flags.C = cy ? 1 : 0;
        return val;
    },

    parityTable: (function() {
        const table = new Array(256);
        for(let i = 0; i < 256; i++) {
            let v = i, p = 0;
            while(v) { p ^= v & 1; v >>= 1; }
            table[i] = (p === 0);
        }
        return table;
    })(),

    getBC: function() { return this.c | (this.b << 8); },
    getDE: function() { return this.e | (this.d << 8); },
    getHL: function() { return this.l | (this.h << 8); },
    setBC: function(v) { this.b = (v >> 8) & 0xFF; this.c = v & 0xFF; },
    setDE: function(v) { this.d = (v >> 8) & 0xFF; this.e = v & 0xFF; },
    setHL: function(v) { this.h = (v >> 8) & 0xFF; this.l = v & 0xFF; },

    push: function(v) {
        this.sp = (this.sp - 1) & 0xFFFF;
        this.memory.write(this.sp, (v >> 8) & 0xFF);
        this.sp = (this.sp - 1) & 0xFFFF;
        this.memory.write(this.sp, v & 0xFF);
    },

    pop: function() {
        const l = this.memory.read(this.sp);
        this.sp = (this.sp + 1) & 0xFFFF;
        const h = this.memory.read(this.sp);
        this.sp = (this.sp + 1) & 0xFFFF;
        return (h << 8) | l;
    },

    step: function() {
        if(this.halted) return 4;

        const opcode = this.memory.read(this.pc++);
        this.lastOpcode = opcode;

        switch(opcode) {
            case 0x00: return 4;
            case 0x01: this.c = this.memory.read(this.pc++); this.b = this.memory.read(this.pc++); return 10;
            case 0x02: this.memory.write(this.getBC(), this.a); return 7;
            case 0x03: this.setBC((this.getBC() + 1) & 0xFFFF); return 5;
            case 0x04: this.b = this.setFlags((this.b + 1) & 0xFF); return 5;
            case 0x05: this.b = this.setFlags((this.b - 1) & 0xFF); return 5;
            case 0x06: this.b = this.memory.read(this.pc++); return 7;
            case 0x07: this.flags.C = (this.a >> 7) & 1; this.a = ((this.a << 1) | this.flags.C) & 0xFF; return 4;
            case 0x09: {
                const hl = this.getHL(); const bc = this.getBC();
                const res = hl + bc;
                this.setHL(res & 0xFFFF);
                this.flags.C = (res > 0xFFFF) ? 1 : 0;
                return 10;
            }
            case 0x0A: this.a = this.memory.read(this.getBC()); return 7;
            case 0x0B: this.setBC((this.getBC() - 1) & 0xFFFF); return 5;
            case 0x0C: this.c = this.setFlags((this.c + 1) & 0xFF); return 5;
            case 0x0D: this.c = this.setFlags((this.c - 1) & 0xFF); return 5;
            case 0x0E: this.c = this.memory.read(this.pc++); return 7;
            case 0x0F: this.flags.C = this.a & 1; this.a = ((this.a >> 1) | (this.flags.C << 7)) & 0xFF; return 4;
            case 0x11: this.e = this.memory.read(this.pc++); this.d = this.memory.read(this.pc++); return 10;
            case 0x12: this.memory.write(this.getDE(), this.a); return 7;
            case 0x13: this.setDE((this.getDE() + 1) & 0xFFFF); return 5;
            case 0x14: this.d = this.setFlags((this.d + 1) & 0xFF); return 5;
            case 0x15: this.d = this.setFlags((this.d - 1) & 0xFF); return 5;
            case 0x16: this.d = this.memory.read(this.pc++); return 7;
            case 0x17: {
                const oldCy = this.flags.C;
                this.flags.C = (this.a >> 7) & 1;
                this.a = ((this.a << 1) | oldCy) & 0xFF;
                return 4;
            }
            case 0x19: {
                const hl = this.getHL(); const de = this.getDE();
                const res = hl + de;
                this.setHL(res & 0xFFFF);
                this.flags.C = (res > 0xFFFF) ? 1 : 0;
                return 10;
            }
            case 0x1A: this.a = this.memory.read(this.getDE()); return 7;
            case 0x1B: this.setDE((this.getDE() - 1) & 0xFFFF); return 5;
            case 0x1C: this.e = this.setFlags((this.e + 1) & 0xFF); return 5;
            case 0x1D: this.e = this.setFlags((this.e - 1) & 0xFF); return 5;
            case 0x1E: this.e = this.memory.read(this.pc++); return 7;
            case 0x1F: {
                const oldCy = this.flags.C;
                this.flags.C = this.a & 1;
                this.a = ((this.a >> 1) | (oldCy << 7)) & 0xFF;
                return 4;
            }
            case 0x21: this.l = this.memory.read(this.pc++); this.h = this.memory.read(this.pc++); return 10;
            case 0x22: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                this.memory.write(addr, this.l);
                this.memory.write(addr + 1, this.h);
                return 16;
            }
            case 0x23: this.setHL((this.getHL() + 1) & 0xFFFF); return 5;
            case 0x24: this.h = this.setFlags((this.h + 1) & 0xFF); return 5;
            case 0x25: this.h = this.setFlags((this.h - 1) & 0xFF); return 5;
            case 0x26: this.h = this.memory.read(this.pc++); return 7;
            case 0x27: {
                let lo = this.a & 0x0F, hi = this.a >> 4;
                if(lo > 9 || this.flags.AC) lo += 6;
                if(lo > 0x0F) { hi++; lo &= 0x0F; this.flags.AC = 1; }
                if(hi > 9 || this.flags.C) hi += 6;
                if(hi > 0x0F) this.flags.C = 1;
                this.a = (hi << 4) | lo;
                this.setFlags(this.a);
                return 4;
            }
            case 0x29: {
                const hl = this.getHL();
                const res = hl + hl;
                this.setHL(res & 0xFFFF);
                this.flags.C = (res > 0xFFFF) ? 1 : 0;
                return 10;
            }
            case 0x2A: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                this.l = this.memory.read(addr);
                this.h = this.memory.read(addr + 1);
                return 16;
            }
            case 0x2B: this.setHL((this.getHL() - 1) & 0xFFFF); return 5;
            case 0x2C: this.l = this.setFlags((this.l + 1) & 0xFF); return 5;
            case 0x2D: this.l = this.setFlags((this.l - 1) & 0xFF); return 5;
            case 0x2E: this.l = this.memory.read(this.pc++); return 7;
            case 0x2F: this.a ^= 0xFF; return 4;
            case 0x31: this.sp = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8); return 10;
            case 0x32: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                this.memory.write(addr, this.a);
                return 13;
            }
            case 0x33: this.sp = (this.sp + 1) & 0xFFFF; return 5;
            case 0x34: {
                const addr = this.getHL();
                this.memory.write(addr, this.setFlags((this.memory.read(addr) + 1) & 0xFF));
                return 10;
            }
            case 0x35: {
                const addr = this.getHL();
                this.memory.write(addr, this.setFlags((this.memory.read(addr) - 1) & 0xFF));
                return 10;
            }
            case 0x36: this.memory.write(this.getHL(), this.memory.read(this.pc++)); return 10;
            case 0x37: this.flags.C = 1; return 4;
            case 0x39: {
                const hl = this.getHL(); const res = hl + this.sp;
                this.setHL(res & 0xFFFF);
                this.flags.C = (res > 0xFFFF) ? 1 : 0;
                return 10;
            }
            case 0x3A: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                this.a = this.memory.read(addr);
                return 13;
            }
            case 0x3B: this.sp = (this.sp - 1) & 0xFFFF; return 5;
            case 0x3C: this.a = this.setFlags((this.a + 1) & 0xFF); return 5;
            case 0x3D: this.a = this.setFlags((this.a - 1) & 0xFF); return 5;
            case 0x3E: this.a = this.memory.read(this.pc++); return 7;
            case 0x3F: this.flags.C ^= 1; return 4;
            case 0x40: case 0x41: case 0x42: case 0x43: case 0x44: case 0x45: case 0x46: case 0x47:
            case 0x48: case 0x49: case 0x4A: case 0x4B: case 0x4C: case 0x4D: case 0x4E: case 0x4F:
            case 0x50: case 0x51: case 0x52: case 0x53: case 0x54: case 0x55: case 0x56: case 0x57:
            case 0x58: case 0x59: case 0x5A: case 0x5B: case 0x5C: case 0x5D: case 0x5E: case 0x5F:
            case 0x60: case 0x61: case 0x62: case 0x63: case 0x64: case 0x65: case 0x66: case 0x67:
            case 0x68: case 0x69: case 0x6A: case 0x6B: case 0x6C: case 0x6D: case 0x6E: case 0x6F:
            case 0x70: case 0x71: case 0x72: case 0x73: case 0x74: case 0x75: case 0x76: case 0x77:
            case 0x78: case 0x79: case 0x7A: case 0x7B: case 0x7C: case 0x7D: case 0x7E: case 0x7F: {
                const src = opcode & 7;
                const dst = (opcode >> 3) & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                if(opcode === 0x76) { this.halted = true; return 7; }
                if(src === 6) {
                    regs[6] = this.memory.read(this.getHL());
                }
                if(dst === 6) {
                    this.memory.write(this.getHL(), regs[src]);
                } else {
                    const setRegs = ['b','c','d','e','h','l',null,'a'];
                    this[setRegs[dst]] = regs[src];
                }
                return (src === 6 || dst === 6) ? 7 : 5;
            }
            case 0x80: case 0x81: case 0x82: case 0x83: case 0x84: case 0x85: case 0x86: case 0x87: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                const res = this.a + val;
                this.a = this.setFlags(res & 0xFF, res > 0xFF, ((this.a & 0x0F) + (val & 0x0F)) > 0x0F);
                return (src === 6) ? 7 : 4;
            }
            case 0x88: case 0x89: case 0x8A: case 0x8B: case 0x8C: case 0x8D: case 0x8E: case 0x8F: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                const res = this.a + val + this.flags.C;
                this.a = this.setFlags(res & 0xFF, res > 0xFF, ((this.a & 0x0F) + (val & 0x0F) + this.flags.C) > 0x0F);
                return (src === 6) ? 7 : 4;
            }
            case 0x90: case 0x91: case 0x92: case 0x93: case 0x94: case 0x95: case 0x96: case 0x97: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                const res = this.a - val;
                this.a = this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < (val & 0x0F));
                return (src === 6) ? 7 : 4;
            }
            case 0x98: case 0x99: case 0x9A: case 0x9B: case 0x9C: case 0x9D: case 0x9E: case 0x9F: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                const res = this.a - val - this.flags.C;
                this.a = this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < ((val + this.flags.C) & 0x0F));
                return (src === 6) ? 7 : 4;
            }
            case 0xA0: case 0xA1: case 0xA2: case 0xA3: case 0xA4: case 0xA5: case 0xA6: case 0xA7: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                this.a = this.setFlags(this.a & val);
                this.flags.AC = 1;
                this.flags.C = 0;
                return (src === 6) ? 7 : 4;
            }
            case 0xA8: case 0xA9: case 0xAA: case 0xAB: case 0xAC: case 0xAD: case 0xAE: case 0xAF: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                this.a = this.setFlags(this.a ^ val);
                this.flags.AC = 0;
                this.flags.C = 0;
                return (src === 6) ? 7 : 4;
            }
            case 0xB0: case 0xB1: case 0xB2: case 0xB3: case 0xB4: case 0xB5: case 0xB6: case 0xB7: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                this.a = this.setFlags(this.a | val);
                this.flags.AC = 0;
                this.flags.C = 0;
                return (src === 6) ? 7 : 4;
            }
            case 0xB8: case 0xB9: case 0xBA: case 0xBB: case 0xBC: case 0xBD: case 0xBE: case 0xBF: {
                const src = opcode & 7;
                const regs = [this.b, this.c, this.d, this.e, this.h, this.l, 0, this.a];
                let val = regs[src];
                if(src === 6) val = this.memory.read(this.getHL());
                const res = this.a - val;
                this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < (val & 0x0F));
                return (src === 6) ? 7 : 4;
            }
            case 0xC0: if(!this.flags.Z) { this.pc = this.pop(); return 11; } return 5;
            case 0xC1: this.setBC(this.pop()); return 10;
            case 0xC2: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.Z) this.pc = addr; return 10;
            }
            case 0xC3: this.pc = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8); return 10;
            case 0xC4: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.Z) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xC5: this.push(this.getBC()); return 11;
            case 0xC6: {
                const val = this.memory.read(this.pc++);
                const res = this.a + val;
                this.a = this.setFlags(res & 0xFF, res > 0xFF, ((this.a & 0x0F) + (val & 0x0F)) > 0x0F);
                return 7;
            }
            case 0xC7: this.push(this.pc); this.pc = 0; return 11;
            case 0xC8: if(this.flags.Z) { this.pc = this.pop(); return 11; } return 5;
            case 0xC9: this.pc = this.pop(); return 10;
            case 0xCA: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.Z) this.pc = addr; return 10;
            }
            case 0xCB: this.pc = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8); return 10;
            case 0xCC: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.Z) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xCD: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                this.push(this.pc); this.pc = addr; return 17;
            }
            case 0xCE: {
                const val = this.memory.read(this.pc++);
                const res = this.a + val + this.flags.C;
                this.a = this.setFlags(res & 0xFF, res > 0xFF, ((this.a & 0x0F) + (val & 0x0F) + this.flags.C) > 0x0F);
                return 7;
            }
            case 0xCF: this.push(this.pc); this.pc = 8; return 11;
            case 0xD0: if(!this.flags.C) { this.pc = this.pop(); return 11; } return 5;
            case 0xD1: this.setDE(this.pop()); return 10;
            case 0xD2: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.C) this.pc = addr; return 10;
            }
            case 0xD3: {
                const port = this.memory.read(this.pc++);
                this.ports.write(port, this.a);
                return 10;
            }
            case 0xD4: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.C) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xD5: this.push(this.getDE()); return 11;
            case 0xD6: {
                const val = this.memory.read(this.pc++);
                const res = this.a - val;
                this.a = this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < (val & 0x0F));
                return 7;
            }
            case 0xD7: this.push(this.pc); this.pc = 16; return 11;
            case 0xD8: if(this.flags.C) { this.pc = this.pop(); return 11; } return 5;
            case 0xD9: this.pc = this.pop(); return 10;
            case 0xDA: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.C) this.pc = addr; return 10;
            }
            case 0xDB: {
                const port = this.memory.read(this.pc++);
                this.a = this.ports.read(port);
                return 10;
            }
            case 0xDC: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.C) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xDD: this.pc = this.pop(); return 10;
            case 0xDE: {
                const val = this.memory.read(this.pc++);
                const res = this.a - val - this.flags.C;
                this.a = this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < ((val + this.flags.C) & 0x0F));
                return 7;
            }
            case 0xDF: this.push(this.pc); this.pc = 24; return 11;
            case 0xE0: if(!this.flags.P) { this.pc = this.pop(); return 11; } return 5;
            case 0xE1: this.setHL(this.pop()); return 10;
            case 0xE2: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.P) this.pc = addr; return 10;
            }
            case 0xE3: {
                const hl = this.getHL();
                const tmp = this.memory.read(this.sp) | (this.memory.read(this.sp + 1) << 8);
                this.memory.write(this.sp, hl & 0xFF);
                this.memory.write(this.sp + 1, hl >> 8);
                this.setHL(tmp);
                return 18;
            }
            case 0xE4: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.P) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xE5: this.push(this.getHL()); return 11;
            case 0xE6: {
                const val = this.memory.read(this.pc++);
                this.a = this.setFlags(this.a & val);
                this.flags.AC = 1;
                this.flags.C = 0;
                return 7;
            }
            case 0xE7: this.push(this.pc); this.pc = 32; return 11;
            case 0xE8: if(this.flags.P) { this.pc = this.pop(); return 11; } return 5;
            case 0xE9: this.pc = this.getHL(); return 5;
            case 0xEA: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.P) this.pc = addr; return 10;
            }
            case 0xEB: {
                const de = this.getDE(); const hl = this.getHL();
                this.setHL(de); this.setDE(hl);
                return 4;
            }
            case 0xEC: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.P) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xED: this.pc = this.pop(); return 10;
            case 0xEE: {
                const val = this.memory.read(this.pc++);
                this.a = this.setFlags(this.a ^ val);
                this.flags.AC = 0;
                this.flags.C = 0;
                return 7;
            }
            case 0xEF: this.push(this.pc); this.pc = 40; return 11;
            case 0xF0: if(!this.flags.S) { this.pc = this.pop(); return 11; } return 5;
            case 0xF1: {
                const flags = this.memory.read(this.sp);
                this.flags.S = (flags >> 7) & 1;
                this.flags.Z = (flags >> 6) & 1;
                this.flags.AC = (flags >> 4) & 1;
                this.flags.P = (flags >> 2) & 1;
                this.flags.C = (flags >> 0) & 1;
                this.sp = (this.sp + 1) & 0xFFFF;
                this.a = this.memory.read(this.sp);
                this.sp = (this.sp + 1) & 0xFFFF;
                return 10;
            }
            case 0xF2: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.S) this.pc = addr; return 10;
            }
            case 0xF3: this.interrupts = false; return 4;
            case 0xF4: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(!this.flags.S) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xF5: {
                const flags = (this.flags.S << 7) | (this.flags.Z << 6) | (this.flags.AC << 4) | (this.flags.P << 2) | (this.flags.C);
                this.push((this.a << 8) | flags);
                return 11;
            }
            case 0xF6: {
                const val = this.memory.read(this.pc++);
                this.a = this.setFlags(this.a | val);
                this.flags.AC = 0;
                this.flags.C = 0;
                return 7;
            }
            case 0xF7: this.push(this.pc); this.pc = 48; return 11;
            case 0xF8: if(this.flags.S) { this.pc = this.pop(); return 11; } return 5;
            case 0xF9: this.sp = this.getHL(); return 5;
            case 0xFA: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.S) this.pc = addr; return 10;
            }
            case 0xFB: this.interrupts = true; return 4;
            case 0xFC: {
                const addr = this.memory.read(this.pc++) | (this.memory.read(this.pc++) << 8);
                if(this.flags.S) { this.push(this.pc); this.pc = addr; return 17; } return 11;
            }
            case 0xFD: this.pc = this.pop(); return 10;
            case 0xFE: {
                const val = this.memory.read(this.pc++);
                const res = this.a - val;
                this.setFlags(res & 0xFF, res < 0, (this.a & 0x0F) < (val & 0x0F));
                return 7;
            }
            case 0xFF: this.push(this.pc); this.pc = 56; return 11;
            default: return 4;
        }
    }
};

// ============================================================================
// Memory System (RAM-Only)
// ============================================================================
function Memory() {
    this.ram = new Uint8Array(0x8000);
    this.vram = new Uint8Array(0x8000);
    this.ram.fill(0);
    this.vram.fill(0);
}

Memory.prototype = {
    read: function(addr) {
        if(addr < 0x8000) return this.ram[addr];
        return this.vram[addr - 0x8000];
    },

    write: function(addr, val) {
        val &= 0xFF;
        if(addr < 0x8000) this.ram[addr] = val;
        else this.vram[addr - 0x8000] = val;
    },

    loadProgram: function(addr, data) {
        if(addr < 0x8000) {
            const maxLen = Math.min(data.length, 0x8000 - addr);
            this.ram.set(data.slice(0, maxLen), addr);
        }
    },

    // NEW: Clear all memory
    clear: function() {
        this.ram.fill(0);
        this.vram.fill(0);
    }
};

// ============================================================================
// Video Subsystem
// ============================================================================
function Video(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.image = this.ctx.createImageData(256, 256);
    this.borderColor = 0;

    this.palette = [
        [0,0,0], [0,0,192], [0,192,0], [0,192,192],
        [192,0,0], [192,0,192], [192,192,0], [192,192,192],
        [64,64,64], [64,64,255], [64,255,64], [64,255,255],
        [255,64,64], [255,64,255], [255,255,64], [255,255,255]
    ].map(c => ({r:c[0], g:c[1], b:c[2]}));

    this.planeCanvas = document.getElementById('planeView');
    this.planeCtx = this.planeCanvas ? this.planeCanvas.getContext('2d') : null;
    this.setBorder(0);
}

Video.prototype = {
    setBorder: function(color) {
        this.borderColor = color & 0x0F;
        const c = this.palette[this.borderColor];
        this.canvas.style.border = `3px solid rgb(${c.r},${c.g},${c.b})`;
    },

    render: function(vram) {
        const data = this.image.data;
        const bc = this.palette[this.borderColor];

        for(let i = 0; i < data.length; i += 4) {
            data[i] = bc.r; data[i+1] = bc.g; data[i+2] = bc.b; data[i+3] = 255;
        }

        // FIXED: Column-major layout - iterate columns first
        // Each column of 8 pixels is 256 bytes tall in memory
        for(let x = 0; x < 256; x += 8) {
            const colOffset = (x >> 3) * 256;
            for(let y = 0; y < 256; y++) {
                const offset = colOffset + y;

                const b0 = vram[offset];
                const b1 = vram[offset + 0x2000];
                const b2 = vram[offset + 0x4000];
                const b3 = vram[offset + 0x6000];

                for(let bit = 0; bit < 8; bit++) {
                    const mask = 0x80 >> bit;
                    const colorIndex =
                        ((b0 & mask) ? 1 : 0) |
                        ((b1 & mask) ? 2 : 0) |
                        ((b2 & mask) ? 4 : 0) |
                        ((b3 & mask) ? 8 : 0);

                    const px = x + bit;
                    const py = 255 - y;  // Bottom-left origin
                    const idx = (py * 256 + px) * 4;

                    const color = this.palette[colorIndex];
                    data[idx] = color.r;
                    data[idx+1] = color.g;
                    data[idx+2] = color.b;
                    data[idx+3] = 255;
                }
            }
        }

        this.ctx.putImageData(this.image, 0, 0);
    },

    renderMiniPlanes: function(vram) {
        if(!this.planeCtx) return;

        const ctx = this.planeCtx;
        const img = ctx.createImageData(256, 64);
        const data = img.data;

        for(let p = 0; p < 4; p++) {
            const planeOffset = p * 0x2000;
            const color = p === 0 ? 255 : p === 1 ? 0xFF0000 : p === 2 ? 0x00FF00 : 0xFFFF00;

            for(let y = 0; y < 16; y++) {
                for(let x = 0; x < 256; x += 8) {
                    const byte = vram[planeOffset + y * 32 + (x >> 3)];
                    for(let bit = 0; bit < 8; bit++) {
                        if(byte & (0x80 >> bit)) {
                            const px = x + bit;
                            const py = p * 16 + y;
                            const idx = (py * 256 + px) * 4;
                            data[idx] = (color >> 16) & 0xFF;
                            data[idx+1] = (color >> 8) & 0xFF;
                            data[idx+2] = color & 0xFF;
                            data[idx+3] = 255;
                        }
                    }
                }
            }
        }

        ctx.putImageData(img, 0, 0);
    }
};

// ============================================================================
// Sound Generator with State Tracking
// ============================================================================
function Sound() {
    this.audioContext = null;
    this.oscillators = [null, null, null];
    this.gainNodes = [null, null, null];
    this.noiseNode = null;
    this.noiseGain = null;
    this.masterGain = null;
    this.enabled = false;

    this.state = {
        channels: [false, false, false, false],
        freqDiv: [0, 0, 0],
        type: ['TONE', 'TONE', 'TONE', 'NOISE'],
        lastPort: 0
    };

    try {
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.audioContext.createGain();
        this.masterGain.gain.value = 0.05;
        this.masterGain.connect(this.audioContext.destination);
        this.enabled = true;
    } catch(e) {
        console.log('Web Audio not supported');
    }
}

Sound.prototype = {
    write: function(val) {
        if(!this.enabled) return;

        this.state.lastPort = val;
        const freqDiv = val & 0x1F;
        const channel = (val >> 5) & 3;
        const type = (val >> 7) & 1;

        if(channel < 3) {
            if(this.oscillators[channel]) {
                this.oscillators[channel].stop();
                this.oscillators[channel] = null;
                this.state.channels[channel] = false;
            }
        }

        if(this.noiseNode && channel === 3) {
            this.noiseNode.stop();
            this.noiseNode = null;
            this.state.channels[3] = false;
        }

        if(freqDiv === 0) return;

        const freq = 220 * (freqDiv || 1);
        this.state.freqDiv[channel] = freqDiv;

        if(type === 0 && channel < 3) {
            this.state.channels[channel] = true;
            this.state.type[channel] = 'TONE';
            this.oscillators[channel] = this.audioContext.createOscillator();
            this.gainNodes[channel] = this.audioContext.createGain();
            this.oscillators[channel].type = 'square';
            this.oscillators[channel].frequency.setValueAtTime(freq, this.audioContext.currentTime);
            this.gainNodes[channel].gain.setValueAtTime(0.1, this.audioContext.currentTime);
            this.oscillators[channel].connect(this.gainNodes[channel]);
            this.gainNodes[channel].connect(this.masterGain);
            this.oscillators[channel].start();
        } else if(type === 1) {
            this.state.channels[3] = true;
            this.state.type[3] = 'NOISE';
            this.generateNoise();
        }
    },

    generateNoise: function() {
        const duration = 0.5;
        const sampleRate = this.audioContext.sampleRate;
        const bufferSize = sampleRate * duration;

        const buffer = this.audioContext.createBuffer(1, bufferSize, sampleRate);
        const data = buffer.getChannelData(0);

        for(let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * 0.3;
        }

        if(this.noiseNode) this.noiseNode.stop();

        this.noiseNode = this.audioContext.createBufferSource();
        this.noiseGain = this.audioContext.createGain();
        this.noiseNode.buffer = buffer;
        this.noiseGain.gain.value = 0.1;
        this.noiseNode.connect(this.noiseGain);
        this.noiseGain.connect(this.masterGain);
        this.noiseNode.loop = true;
        this.noiseNode.start();
    },

    stopAll: function() {
        if(!this.enabled) return;
        for(let i = 0; i < 3; i++) {
            if(this.oscillators[i]) {
                this.oscillators[i].stop();
                this.oscillators[i] = null;
                this.state.channels[i] = false;
            }
        }
        if(this.noiseNode) {
            this.noiseNode.stop();
            this.noiseNode = null;
            this.state.channels[3] = false;
        }
    }
};

// ============================================================================
// Keyboard Matrix
// ============================================================================
function Keyboard() {
    this.row = 0;
    this.matrix = new Array(8).fill(0xFF);

    this.keyMap = {
        'Escape': [0,0xFE], 'F1': [0,0xFD], 'F2': [0,0xFB], 'F3': [0,0xF7],
        'F4': [0,0xEF], 'F5': [0,0xDF],
        'Digit1': [1,0xFE], 'Digit2': [1,0xFD], 'Digit3': [1,0xFB], 'Digit4': [1,0xF7], 'Digit5': [1,0xEF],
        'Digit6': [2,0xFE], 'Digit7': [2,0xFD], 'Digit8': [2,0xFB], 'Digit9': [2,0xF7], 'Digit0': [2,0xEF],
        'Minus': [3,0xFE], 'Equal': [3,0xFD], 'Backspace': [3,0xFB], 'Delete': [3,0xF7],
        'Tab': [4,0xFE], 'KeyQ': [4,0xFD], 'KeyW': [4,0xFB], 'KeyE': [4,0xF7], 'KeyR': [4,0xEF], 'KeyT': [4,0xDF],
        'KeyY': [5,0xFE], 'KeyU': [5,0xFD], 'KeyI': [5,0xFB], 'KeyO': [5,0xF7], 'KeyP': [5,0xEF],
        'BracketLeft': [6,0xFE], 'BracketRight': [6,0xFD], 'Enter': [6,0xFB],
        'KeyA': [7,0xFE], 'KeyS': [7,0xFD], 'KeyD': [7,0xFB], 'KeyF': [7,0xF7], 'KeyG': [7,0xEF],
        'KeyH': [0,0xFE], 'KeyJ': [0,0xFD], 'KeyK': [0,0xFB], 'KeyL': [0,0xF7], 'Semicolon': [0,0xEF], 'Quote': [0,0xDF],
        'KeyZ': [1,0xFE], 'KeyX': [1,0xFD], 'KeyC': [1,0xFB], 'KeyV': [1,0xF7],
        'KeyB': [2,0xFE], 'KeyN': [2,0xFD], 'KeyM': [2,0xFB], 'Comma': [2,0xF7], 'Period': [2,0xEF], 'Slash': [2,0xDF],
        'Space': [3,0xFE], 'ArrowLeft': [4,0xFE], 'ArrowRight': [4,0xFD],
        'ArrowUp': [5,0xFE], 'ArrowDown': [5,0xFD]
    };

    this.setupEvents();
}

Keyboard.prototype = {
    setupEvents: function() {
        window.addEventListener('keydown', (e) => {
            const map = this.keyMap[e.code];
            if(map) {
                this.matrix[map[0]] &= map[1];
                e.preventDefault();
            }
        });

        window.addEventListener('keyup', (e) => {
            const map = this.keyMap[e.code];
            if(map) {
                this.matrix[map[0]] |= ~map[1] & 0xFF;
            }
        });
    },

    selectRow: function(row) {
        this.row = row & 7;
    },

    read: function() {
        return this.matrix[this.row];
    }
};

// ============================================================================
// I/O Ports
// ============================================================================
function Ports(video, sound, keyboard) {
    this.video = video;
    this.sound = sound;
    this.keyboard = keyboard;
    this.borders = 0;

    this.debug = {
        port00: 0,
        port01: 0,
        port02: 0,
        port03: 0
    };
}

Ports.prototype = {
    read: function(port) {
        const val = (() => {
            switch(port & 0xFF) {
                case 0x01: return this.keyboard.read();
                case 0x02: return this.borders;
                default: return 0xFF;
            }
        })();

        if(port === 0x01) this.debug.port01 = val;
        return val;
    },

    write: function(port, val) {
        switch(port & 0xFF) {
            case 0x00: this.keyboard.selectRow(val); this.debug.port00 = val; break;
            case 0x02: this.borders = val; this.video.setBorder(val & 0x0F); this.debug.port02 = val; break;
            case 0x03: this.sound.write(val); this.debug.port03 = val; break;
        }
    }
};

// ============================================================================
// Main Emulator
// ============================================================================
function Vector06CEmulator() {
    this.memory = new Memory();
    this.video = new Video(document.getElementById('screen'));
    this.sound = new Sound();
    this.keyboard = new Keyboard();
    this.ports = new Ports(this.video, this.sound, this.keyboard);
    this.cpu = new CPU8080();

    this.cpu.init(this.memory, this.ports);
    this.createBootloader();

    this.running = false;
    this.singleStepping = false;
    this.frameCycles = 0;
    this.cyclesPerFrame = 60000;
    this.debugVisible = true;
    this.breakpoints = [];

    this.startTime = performance.now();
    this.lastStatsTime = performance.now();
    this.cyclesAtLastStats = 0;
    this.cyclesPerSecond = 0;
    this.totalFrames = 0;

    this.updateStatus('Ready');
}

Vector06CEmulator.prototype = {
    createBootloader: function() {
        this.memory.write(0x0000, 0xC3);
        this.memory.write(0x0001, 0x00);
        this.memory.write(0x0002, 0x01);
        for(let i = 0x0003; i < 0x0100; i++) {
            this.memory.write(i, 0x00);
        }
    },

    reset: function() {
        this.cpu.reset();
        this.sound.stopAll();
        this.running = false;
        this.singleStepping = false;
        this.frameCycles = 0;
        this.startTime = performance.now();
        this.lastStatsTime = performance.now();
        this.cyclesAtLastStats = 0;
        this.cyclesPerSecond = 0;
        this.totalFrames = 0;
        this.updateStatus('Reset');
        this.video.render(this.memory.vram);
        if(this.debugVisible) this.updateDebug();
    },

    run: function() {
        if(this.running) return;
        this.running = true;
        this.singleStepping = false;
        this.updateStatus('Running');
        this.mainLoop();
    },

    stop: function() {
        this.running = false;
        this.singleStepping = false;
        this.sound.stopAll();
        this.updateStatus('Stopped');
    },

    step: function() {
        if(this.running && !this.singleStepping) return;

        this.singleStepping = true;
        this.running = true;

        const pcBefore = this.cpu.pc;
        const cycles = this.cpu.step();
        this.cpu.cycles += cycles;

        if(this.breakpoints.includes(this.cpu.pc)) {
            this.stop();
            alert(`Breakpoint hit at 0x${this.cpu.pc.toString(16).toUpperCase().padStart(4, '0')}`);
        }

        this.updateStatus(`Stepped from 0x${pcBefore.toString(16).toUpperCase().padStart(4, '0')}`);

        if(this.debugVisible) {
            this.updateDebug();
            this.video.render(this.memory.vram);
        }

        if(this.singleStepping) {
            this.running = false;
        }
    },

    stepOver0x100: function() {
        if(this.running && !this.singleStepping) return;

        this.singleStepping = true;
        this.running = true;

        const pcBefore = this.cpu.pc;
        let steps = 0;

        for(let i = 0; i < 0x100; i++) {
            if(this.cpu.halted || !this.running) break;

            const cycles = this.cpu.step();
            this.cpu.cycles += cycles;
            steps++;

            if(this.breakpoints.includes(this.cpu.pc)) {
                this.stop();
                alert(`Breakpoint hit at 0x${this.cpu.pc.toString(16).toUpperCase().padStart(4, '0')}`);
                break;
            }
        }

        this.updateStatus(`Stepped 0x${steps.toString(16)} instr from 0x${pcBefore.toString(16).toUpperCase().padStart(4, '0')}`);

        if(this.debugVisible) {
            this.updateDebug();
            this.video.render(this.memory.vram);
        }

        this.running = false;
        this.singleStepping = false;
    },

    mainLoop: function() {
        if(!this.running) return;

        let cyclesThisFrame = 0;
        while(this.frameCycles < this.cyclesPerFrame) {
            const cycles = this.cpu.step();
            this.cpu.cycles += cycles;
            cyclesThisFrame += cycles;
            this.frameCycles += cycles;

            if(this.breakpoints.includes(this.cpu.pc)) {
                this.stop();
                alert(`Breakpoint hit at 0x${this.cpu.pc.toString(16).toUpperCase().padStart(4, '0')}`);
                break;
            }
        }
        this.frameCycles = 0;
        this.totalFrames++;

        const now = performance.now();
        if(now - this.lastStatsTime >= 1000) {
            this.cyclesPerSecond = (this.cpu.cycles - this.cyclesAtLastStats) / ((now - this.lastStatsTime) / 1000);
            this.cyclesAtLastStats = this.cpu.cycles;
            this.lastStatsTime = now;
        }

        this.video.render(this.memory.vram);

        if(this.debugVisible) {
            this.updateDebug();
        }

        if(this.running) {
            requestAnimationFrame(() => this.mainLoop());
        }
    },

    updateStatus: function(text) {
        const pc = this.cpu.pc.toString(16).toUpperCase().padStart(4, '0');
        const cycles = this.cpu.cycles.toLocaleString();
        document.getElementById('status').textContent = `Status: ${text} | PC: ${pc} | Cycles: ${cycles}`;
    },

    loadProgram: function(addr, data) {
        this.memory.loadProgram(addr, data);
    },

    // NEW: Load ROM file (clears memory first)
    loadROM: function(data) {
        this.memory.clear();           // Clear all memory
        this.createBootloader();       // Recreate bootloader at 0x0000
        this.memory.loadProgram(0x0100, data); // Load ROM at 0x0100
        this.reset();                  // Reset emulator state
        if(this.debugVisible) this.updateDebug();
    },

    setBreakpoint: function() {
        const input = document.getElementById('breakpoint').value.trim();
        if(!input) return;

        const addr = parseInt(input, 16);
        if(isNaN(addr) || addr < 0 || addr > 0xFFFF) {
            alert('Invalid address. Use 4-digit hex (e.g., 0100)');
            return;
        }

        if(!this.breakpoints.includes(addr)) {
            this.breakpoints.push(addr);
        }

        this.updateBreakpointList();
        document.getElementById('breakpoint').value = '';
    },

    clearBreakpoints: function() {
        this.breakpoints = [];
        this.updateBreakpointList();
    },

    updateBreakpointList: function() {
        const list = document.getElementById('bpList');
        if(this.breakpoints.length === 0) {
            list.textContent = 'None';
        } else {
            list.textContent = this.breakpoints.map(bp => '0x' + bp.toString(16).toUpperCase().padStart(4, '0')).join(', ');
        }
    },

    updateDebug: function() {
        this.updateCPUState();
        this.updateMemoryDump();
        this.updateVideoState();
        this.updateSoundState();
        this.updateKeyboardState();
        this.updateIOState();
        this.updateHardwareStats();
        this.updateDisassembly();
    },

    updateCPUState: function() {
        const f = this.cpu.flags;
        const flags = [
            `S=<span class="${f.S ? 'flag-set' : 'flag-clear'}">${f.S}</span>`,
            `Z=<span class="${f.Z ? 'flag-set' : 'flag-clear'}">${f.Z}</span>`,
            `AC=<span class="${f.AC ? 'flag-set' : 'flag-clear'}">${f.AC}</span>`,
            `P=<span class="${f.P ? 'flag-set' : 'flag-clear'}">${f.P}</span>`,
            `C=<span class="${f.C ? 'flag-set' : 'flag-clear'}">${f.C}</span>`
        ].join(' ');

        const state = `PC: ${this.cpu.pc.toString(16).toUpperCase().padStart(4, '0')} | SP: ${this.cpu.sp.toString(16).toUpperCase().padStart(4, '0')}
A: ${this.cpu.a.toString(16).toUpperCase().padStart(2, '0')} | B: ${this.cpu.b.toString(16).toUpperCase().padStart(2, '0')} | C: ${this.cpu.c.toString(16).toUpperCase().padStart(2, '0')}
D: ${this.cpu.d.toString(16).toUpperCase().padStart(2, '0')} | E: ${this.cpu.e.toString(16).toUpperCase().padStart(2, '0')}
H: ${this.cpu.h.toString(16).toUpperCase().padStart(2, '0')} | L: ${this.cpu.l.toString(16).toUpperCase().padStart(2, '0')}
Flags: ${flags}
Opcode: ${this.cpu.lastOpcode.toString(16).toUpperCase().padStart(2, '0')}
HLT: ${this.cpu.halted ? 1 : 0}`;

        document.getElementById('cpuState').innerHTML = state;
    },

    updateMemoryDump: function() {
        const input = document.getElementById('memAddr').value.trim() || '0100';
        const addr = parseInt(input, 16);
        if(isNaN(addr)) return;

        let dump = '';
        for(let row = 0; row < 4; row++) {
            const rowAddr = addr + row * 16;
            dump += rowAddr.toString(16).toUpperCase().padStart(4, '0') + ': ';

            for(let col = 0; col < 16; col++) {
                const val = this.memory.read(rowAddr + col);
                dump += val.toString(16).toUpperCase().padStart(2, '0') + ' ';
            }
            dump += '\n';
        }

        document.getElementById('memoryDump').textContent = dump;
    },

    updateVideoState: function() {
        const border = this.video.borderColor;
        const borderName = ['Black', 'Blue', 'Green', 'Cyan', 'Red', 'Magenta', 'Yellow', 'White'][border];

        const vramSample = [];
        for(let i = 0; i < 4; i++) {
            vramSample.push(this.memory.vram[i].toString(16).toUpperCase().padStart(2, '0'));
        }

        const state = `Border: ${border} (${borderName})
Plane 0: 8000-9FFF
Plane 1: A000-BFFF
Plane 2: C000-DFFF
Plane 3: E000-FFFF
VRAM: ${vramSample.join(' ')}...`;

        document.getElementById('videoState').textContent = state;
        this.video.renderMiniPlanes(this.memory.vram);
    },

    updateSoundState: function() {
        const s = this.sound.state;
        const ch = s.channels.map((on, i) => `${i}:${on ? 'ON ' : 'OFF'}`).join(' ');

        const state = `CH: ${ch}
Freq: ${s.freqDiv.join(' ')}
Type: ${s.type.join(' ')}`;

        document.getElementById('soundState').textContent = state;
    },

    updateKeyboardState: function() {
        const state = `Row: ${this.keyboard.row}
0:${this.keyboard.matrix[0].toString(2).padStart(8, '0')} 1:${this.keyboard.matrix[1].toString(2).padStart(8, '0')}
2:${this.keyboard.matrix[2].toString(2).padStart(8, '0')} 3:${this.keyboard.matrix[3].toString(2).padStart(8, '0')}
4:${this.keyboard.matrix[4].toString(2).padStart(8, '0')} 5:${this.keyboard.matrix[5].toString(2).padStart(8, '0')}
6:${this.keyboard.matrix[6].toString(2).padStart(8, '0')} 7:${this.keyboard.matrix[7].toString(2).padStart(8, '0')}
Read: ${this.keyboard.read().toString(16).toUpperCase().padStart(2, '0')}`;

        document.getElementById('kbdState').textContent = state;
    },

    updateIOState: function() {
        const d = this.ports.debug;
        const state = `P00: ${d.port00.toString(16).toUpperCase().padStart(2, '0')} (Row)
P01: ${d.port01.toString(16).toUpperCase().padStart(2, '0')} (Kbd)
P02: ${d.port02.toString(16).toUpperCase().padStart(2, '0')} (Border)
P03: ${d.port03.toString(16).toUpperCase().padStart(2, '0')} (Sound)`;

        document.getElementById('ioState').textContent = state;
    },

    updateHardwareStats: function() {
        const ramUsed = this.memory.ram.filter(b => b !== 0).length;
        const vramUsed = this.memory.vram.filter(b => b !== 0).length;
        const uptime = ((performance.now() - this.startTime) / 1000).toFixed(1);

        const stats = `CPU: ${Math.floor(this.cyclesPerSecond / 1000)}KHz
RAM: ${(ramUsed/this.memory.ram.length*100).toFixed(1)}% VRAM: ${(vramUsed/this.memory.vram.length*100).toFixed(1)}%
Uptime: ${uptime}s
Frames: ${this.totalFrames}
Status: ${this.cpu.halted ? 'HALTED' : (this.running ? (this.singleStepping ? 'STEP' : 'RUN') : 'STOP')}`;

        document.getElementById('hardwareStats').textContent = stats;
    },

    updateDisassembly: function() {
        const input = document.getElementById('disasmAddr').value.trim();
        let addr = this.cpu.pc;
        if(input) {
            const parsed = parseInt(input, 16);
            if(!isNaN(parsed)) addr = parsed;
        }

        let disassembly = '';
        const lines = 14;
        let currentAddr = addr;

        for(let i = 0; i < lines; i++) {
            if(currentAddr > 0xFFFF) break;

            const isPC = currentAddr === this.cpu.pc;
            const isBP = this.breakpoints.includes(currentAddr);
            let line = '';

            line += currentAddr.toString(16).toUpperCase().padStart(4, '0') + ': ';

            const opcode = this.memory.read(currentAddr);
            let bytes = opcode.toString(16).toUpperCase().padStart(2, '0');
            let instrLen = 1;

            if((opcode >= 0x01 && opcode <= 0x06) || (opcode >= 0x0E && opcode <= 0x16) ||
               (opcode >= 0x1E && opcode <= 0x26) || (opcode >= 0x2E && opcode <= 0x36) ||
               (opcode >= 0x3E && opcode <= 0x3F) || opcode === 0xC6 || opcode === 0xCE ||
               opcode === 0xD6 || opcode === 0xDE || opcode === 0xE6 || opcode === 0xEE ||
               opcode === 0xF6 || opcode === 0xFE) {
                instrLen = 2;
                bytes += ' ' + this.memory.read(currentAddr + 1).toString(16).toUpperCase().padStart(2, '0');
            } else if((opcode >= 0x01 && opcode <= 0x03) || opcode === 0x11 || opcode === 0x13 ||
                      opcode === 0x21 || opcode === 0x23 || opcode === 0x31 || opcode === 0x33 ||
                      (opcode >= 0xC2 && opcode <= 0xC3) || (opcode >= 0xC4 && opcode <= 0xC5) ||
                      (opcode >= 0xCA && opcode <= 0xCB) || (opcode >= 0xCC && opcode <= 0xCD) ||
                      (opcode >= 0xD2 && opcode <= 0xD3) || (opcode >= 0xD4 && opcode <= 0xD5) ||
                      (opcode >= 0xDA && opcode <= 0xDB) || (opcode >= 0xDC && opcode <= 0xDD) ||
                      (opcode >= 0xE2 && opcode <= 0xE3) || (opcode >= 0xE4 && opcode <= 0xE5) ||
                      (opcode >= 0xEA && opcode <= 0xEB) || (opcode >= 0xEC && opcode <= 0xED) ||
                      (opcode >= 0xF2 && opcode <= 0xF3) || (opcode >= 0xF4 && opcode <= 0xF5) ||
                      (opcode >= 0xFA && opcode <= 0xFB) || (opcode >= 0xFC && opcode <= 0xFD) ||
                      opcode === 0x22 || opcode === 0x2A || opcode === 0x32 || opcode === 0x3A) {
                instrLen = 3;
                bytes += ' ' + this.memory.read(currentAddr + 1).toString(16).toUpperCase().padStart(2, '0');
                bytes += ' ' + this.memory.read(currentAddr + 2).toString(16).toUpperCase().padStart(2, '0');
            }

            line += bytes.padEnd(9, ' ') + this.disassembleInstr(currentAddr, opcode);

            let className = 'disasm-line';
            if(isPC) className += ' disasm-pc';
            if(isBP) className += ' disasm-breakpoint';

            disassembly += `<div class="${className}">${line}</div>`;
            currentAddr += instrLen;
        }

        document.getElementById('disassembly').innerHTML = disassembly;
    },

    disassembleInstr: function(addr, opcode) {
        const regs = ['B', 'C', 'D', 'E', 'H', 'L', 'M', 'A'];

        if(opcode >= 0x40 && opcode <= 0x7F) {
            if(opcode === 0x76) return 'HLT';
            const dst = (opcode >> 3) & 7;
            const src = opcode & 7;
            return `MOV ${regs[dst]},${regs[src]}`;
        }

        if(opcode >= 0x80 && opcode <= 0xBF) {
            const src = opcode & 7;
            const group = (opcode >> 3) & 7;
            const mnemonics = ['ADD', 'ADC', 'SUB', 'SBB', 'ANA', 'XRA', 'ORA', 'CMP'];
            return `${mnemonics[group]} ${regs[src]}`;
        }

        switch(opcode) {
            case 0x00: return 'NOP';
            case 0x01: return `LXI B,${this.getWord(addr + 1)}`;
            case 0x02: return 'STAX B';
            case 0x03: return 'INX B';
            case 0x04: return 'INR B';
            case 0x05: return 'DCR B';
            case 0x06: return `MVI B,${this.getByte(addr + 1)}`;
            case 0x07: return 'RLC';
            case 0x09: return 'DAD B';
            case 0x0A: return 'LDAX B';
            case 0x0B: return 'DCX B';
            case 0x0C: return 'INR C';
            case 0x0D: return 'DCR C';
            case 0x0E: return `MVI C,${this.getByte(addr + 1)}`;
            case 0x0F: return 'RRC';
            case 0x11: return `LXI D,${this.getWord(addr + 1)}`;
            case 0x12: return 'STAX D';
            case 0x13: return 'INX D';
            case 0x14: return 'INR D';
            case 0x15: return 'DCR D';
            case 0x16: return `MVI D,${this.getByte(addr + 1)}`;
            case 0x17: return 'RAL';
            case 0x19: return 'DAD D';
            case 0x1A: return 'LDAX D';
            case 0x1B: return 'DCX D';
            case 0x1C: return 'INR E';
            case 0x1D: return 'DCR E';
            case 0x1E: return `MVI E,${this.getByte(addr + 1)}`;
            case 0x1F: return 'RAR';
            case 0x21: return `LXI H,${this.getWord(addr + 1)}`;
            case 0x22: return `SHLD ${this.getWord(addr + 1)}`;
            case 0x23: return 'INX H';
            case 0x24: return 'INR H';
            case 0x25: return 'DCR H';
            case 0x26: return `MVI H,${this.getByte(addr + 1)}`;
            case 0x27: return 'DAA';
            case 0x29: return 'DAD H';
            case 0x2A: return `LHLD ${this.getWord(addr + 1)}`;
            case 0x2B: return 'DCX H';
            case 0x2C: return 'INR L';
            case 0x2D: return 'DCR L';
            case 0x2E: return `MVI L,${this.getByte(addr + 1)}`;
            case 0x2F: return 'CMA';
            case 0x31: return `LXI SP,${this.getWord(addr + 1)}`;
            case 0x32: return `STA ${this.getWord(addr + 1)}`;
            case 0x33: return 'INX SP';
            case 0x34: return 'INR M';
            case 0x35: return 'DCR M';
            case 0x36: return `MVI M,${this.getByte(addr + 1)}`;
            case 0x37: return 'STC';
            case 0x39: return 'DAD SP';
            case 0x3A: return `LDA ${this.getWord(addr + 1)}`;
            case 0x3B: return 'DCX SP';
            case 0x3C: return 'INR A';
            case 0x3D: return 'DCR A';
            case 0x3E: return `MVI A,${this.getByte(addr + 1)}`;
            case 0x3F: return 'CMC';
            case 0xC0: return 'RNZ';
            case 0xC1: return 'POP B';
            case 0xC2: return `JNZ ${this.getWord(addr + 1)}`;
            case 0xC3: return `JMP ${this.getWord(addr + 1)}`;
            case 0xC4: return `CNZ ${this.getWord(addr + 1)}`;
            case 0xC5: return 'PUSH B';
            case 0xC6: return `ADI ${this.getByte(addr + 1)}`;
            case 0xC7: return 'RST 0';
            case 0xC8: return 'RZ';
            case 0xC9: return 'RET';
            case 0xCA: return `JZ ${this.getWord(addr + 1)}`;
            case 0xCC: return `CZ ${this.getWord(addr + 1)}`;
            case 0xCD: return `CALL ${this.getWord(addr + 1)}`;
            case 0xCE: return `ACI ${this.getByte(addr + 1)}`;
            case 0xCF: return 'RST 1';
            case 0xD0: return 'RNC';
            case 0xD1: return 'POP D';
            case 0xD2: return `JNC ${this.getWord(addr + 1)}`;
            case 0xD3: return `OUT ${this.getByte(addr + 1)}`;
            case 0xD4: return `CNC ${this.getWord(addr + 1)}`;
            case 0xD5: return 'PUSH D';
            case 0xD6: return `SUI ${this.getByte(addr + 1)}`;
            case 0xD7: return 'RST 2';
            case 0xD8: return 'RC';
            case 0xDA: return `JC ${this.getWord(addr + 1)}`;
            case 0xDB: return `IN ${this.getByte(addr + 1)}`;
            case 0xDC: return `CC ${this.getWord(addr + 1)}`;
            case 0xDE: return `SBI ${this.getByte(addr + 1)}`;
            case 0xDF: return 'RST 3';
            case 0xE0: return 'RPO';
            case 0xE1: return 'POP H';
            case 0xE2: return `JPO ${this.getWord(addr + 1)}`;
            case 0xE3: return 'XTHL';
            case 0xE4: return `CPO ${this.getWord(addr + 1)}`;
            case 0xE5: return 'PUSH H';
            case 0xE6: return `ANI ${this.getByte(addr + 1)}`;
            case 0xE7: return 'RST 4';
            case 0xE8: return 'RPE';
            case 0xE9: return 'PCHL';
            case 0xEA: return `JPE ${this.getWord(addr + 1)}`;
            case 0xEB: return 'XCHG';
            case 0xEC: return `CPE ${this.getWord(addr + 1)}`;
            case 0xEE: return `XRI ${this.getByte(addr + 1)}`;
            case 0xEF: return 'RST 5';
            case 0xF0: return 'RP';
            case 0xF1: return 'POP PSW';
            case 0xF2: return `JP ${this.getWord(addr + 1)}`;
            case 0xF3: return 'DI';
            case 0xF4: return `CP ${this.getWord(addr + 1)}`;
            case 0xF5: return 'PUSH PSW';
            case 0xF6: return `ORI ${this.getByte(addr + 1)}`;
            case 0xF7: return 'RST 6';
            case 0xF8: return 'RM';
            case 0xF9: return 'SPHL';
            case 0xFA: return `JM ${this.getWord(addr + 1)}`;
            case 0xFB: return 'EI';
            case 0xFC: return `CM ${this.getWord(addr + 1)}`;
            case 0xFE: return `CPI ${this.getByte(addr + 1)}`;
            case 0xFF: return 'RST 7';
            default: return `DB ${opcode.toString(16).toUpperCase().padStart(2, '0')}`;
        }
    },

    getByte: function(addr) {
        return this.memory.read(addr).toString(16).toUpperCase().padStart(2, '0');
    },

    getWord: function(addr) {
        const lo = this.memory.read(addr);
        const hi = this.memory.read(addr + 1);
        return ((hi << 8) | lo).toString(16).toUpperCase().padStart(4, '0');
    }
};

// ============================================================================
// Demo Programs
// ============================================================================
function loadGraphicsDemo() {
    const demo = [
        0x31,0x00,0xF0, 0x3E,0x0F,0xD3,0x02, 0x21,0x00,0x80, 0x16,0x00, 0x0E,0x00, 0x3E,0xFF,
        0x77,0x23,0x0C,0xFE,0x20,0xC2,0x0E,0x01, 0x0E,0x00,0x14,0x7A,0xFE,0x10,0xCA,0x18,
        0x01,0xC3,0x0E,0x01, 0x21,0x00,0x80,0x16,0x00,0xC3,0x0E,0x01
    ];

    emulator.loadProgram(0x0100, demo);
    emulator.reset();
    alert('Graphics demo loaded at 0x0100. Click Run or Step to execute.');
}

function loadSoundDemo() {
    const demo = [
        0x31,0x00,0xF0, 0x0E,0x01, 0x3E,0x0F,0xD3,0x03, 0x01,0xFF,0xFF,
        0x0B,0x78,0xB1,0xC2,0x0C,0x01, 0x3E,0x00,0xD3,0x03, 0xC3,0x04,0x01
    ];

    emulator.loadProgram(0x0100, demo);
    emulator.reset();
    alert('Sound demo loaded at 0x0100. Click Run to hear tone.');
}

// ============================================================================
// Debug Panel Controls
// ============================================================================
function toggleDebug() {
    const panel = document.getElementById('debugPanel');
    const button = document.getElementById('debugToggle');

    if(panel.style.display === 'none') {
        panel.style.display = 'block';
        button.textContent = 'Hide Debug';
        emulator.debugVisible = true;
        emulator.updateDebug();
    } else {
        panel.style.display = 'none';
        button.textContent = 'Debug Panel';
        emulator.debugVisible = false;
    }
}

function updateMemoryDump() {
    emulator.updateMemoryDump();
}

function updateDisassembly() {
    emulator.updateDisassembly();
}

// NEW: ROM File Handler
function handleROMFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        emulator.loadROM(data);
        alert(`ROM loaded: ${file.name} (${data.length} bytes at 0x0100)`);
    };
    reader.readAsArrayBuffer(file);

    // Reset file input so same file can be loaded again
    event.target.value = '';
}

// ============================================================================
// Initialization
// ============================================================================
const emulator = new Vector06CEmulator();
emulator.reset();
</script>
</body>
</html>
